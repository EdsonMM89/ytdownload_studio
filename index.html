<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>YTDOWNLOAD Studio</title>
<style>
  :root {--bg:#0b0b0b;--panel:#121212;--muted:#9aa0a6;--accent:#ff4444;--green:#00ff66;}
  html,body{height:100%;margin:0;background:var(--bg);color:#e6e6e6;font-family:Consolas,monospace;}
  header{background:var(--panel);padding:12px;font-weight:700;color:var(--accent);border-bottom:2px solid var(--accent);text-align:center}
  nav{display:flex;justify-content:center;gap:6px;padding:8px;background:#111;border-bottom:1px solid #222}
  nav .tab{padding:8px 14px;border-radius:4px;color:#ddd;cursor:pointer}
  nav .tab.active{background:#171717;color:var(--accent)}
  main{display:flex;gap:16px;padding:16px;height:calc(100% - 120px);box-sizing:border-box}
  textarea{flex:1;background:#0e0e0e;border:1px solid #2b2b2b;color:#fff;padding:12px;resize:none;font-size:13px}
  .run-btn{background:var(--accent);border:none;color:#fff;padding:10px 14px;border-radius:6px;cursor:pointer}
  .console{background:#000;border:1px solid #222;padding:10px;height:240px;overflow:auto;color:var(--green);font-family:monospace;font-size:13px}
  .sidebar{width:220px;background:#0f0f0f;border:1px solid #222;padding:10px;border-radius:6px}
  .file{background:#111;padding:8px;margin:6px 0;border-radius:6px;border:1px solid #222;cursor:pointer;text-align:center}
  .upload{background:#111;text-align:center;cursor:pointer}
  .error{color:#ff6666}
</style>
</head>
<body>
<header>YTDOWNLOAD Studio</header>
<nav id="tabs"></nav>
<main>
  <div style="flex:1;display:flex;flex-direction:column;gap:8px;">
    <textarea id="code" spellcheck="false"></textarea>
    <button class="run-btn" id="runBtn">▶ Ejecutar Código</button>
    <div class="console" id="console"></div>
  </div>
  <div class="sidebar">
    <h3>Archivos</h3>
    <div class="file" onclick="loadExample(0)">simple.ytd</div>
    <div class="file" onclick="loadExample(1)">playlist.ytd</div>
    <div class="file" onclick="loadExample(2)">formatos.ytd</div>
    <hr>
    <div class="file upload" id="uploadBox">Subir .txt</div>
    <input type="file" id="fileInput" accept=".txt" style="display:none">
  </div>
</main>

<script>
const TOK={FUNCION:0,VAR:1,IMPRIMIR:2,LEER:3,DESCARGAR:4,PARA:5,CADA:6,EN:7,HACER:8,SI:9,ENTONCES:10,MIENTRAS:11,FIN:12,MP3:13,MP4:14,CADENA:15,NUM:16,AP:17,CP:18,AL:19,CL:20,IG:21,COM:22,PC:23,PUN:24,ADM:25,MAIN:26,WAV:27,MKV:28,AVI:29,WEBM:30,FLAC:31,LB:32,RB:33,AS:34,ERROR:999,FIN:666};

function tsBase(){
  const k=new Map();
  for(const [n,t] of Object.entries(TOK)) k.set(n,t);
  return k;
}

class Lexer{
  constructor(s){this.s=s;this.i=0;this.len=s.length;}
  isElem(c){return"(){}=,;.![]".includes(c);}
  skip(){while(this.i<this.len&&/\s/.test(this.s[this.i]))this.i++;}
  get(){
    this.skip();if(this.i>=this.len)return TOK.FIN;
    let c=this.s[this.i];
    if(/[A-Za-z]/.test(c)){
      let tmp="";
      while(this.i<this.len&&/[A-Za-z0-9_]/.test(this.s[this.i]))tmp+=this.s[this.i++];
      const up=tmp.toUpperCase();
      if(TOK[up]!=null)return TOK[up];
      return TOK.VAR;
    }
    if(/[0-9]/.test(c)){
      while(this.i<this.len&&/[0-9.]/.test(this.s[this.i]))this.i++;
      return TOK.NUM;
    }
    if(c=="'"){this.i++;while(this.i<this.len&&this.s[this.i]!="'")this.i++;this.i++;return TOK.CADENA;}
    if(this.isElem(c)){this.i++;const map={'(':TOK.AP,')':TOK.CP,'{':TOK.AL,'}':TOK.CL,'=':TOK.IG,',':TOK.COM,';':TOK.PC,'.':TOK.PUN,'!':TOK.ADM,'[':TOK.LB,']':TOK.RB};return map[c]??TOK.ERROR;}
    this.i++;return TOK.ERROR;
  }
  tokenize(){const t=[];while(true){let x=this.get();t.push(x);if(x===TOK.FIN||x===TOK.ERROR)break;}return t;}
}

class Parser{
  constructor(tok){this.t=tok;this.p=0;this.e=0;this.fin=50;this.err=TOK.ERROR;
    this.tab=Array.from({length:60},()=>Array(60).fill(this.err));
    // agregamos soporte a LISTAS
    this.tab[0][TOK.FUNCION]=1;
    this.tab[1][TOK.MAIN]=2;
    this.tab[2][TOK.AP]=3;
    this.tab[3][TOK.CP]=4;
    this.tab[4][TOK.AL]=5;
    this.tab[5][TOK.VAR]=6;
    this.tab[6][TOK.VAR]=7;
    this.tab[7][TOK.IG]=8;
    // aquí admitimos o CADENA o LB
    this.tab[8][TOK.CADENA]=9;
    this.tab[8][TOK.LB]=60; // lista
    this.tab[9][TOK.PC]=10;
    // LISTA: [ CADENA AS CADENA (, ...)? ]
    this.tab[60][TOK.CADENA]=61;
    this.tab[61][TOK.AS]=62;
    this.tab[62][TOK.CADENA]=63;
    this.tab[63][TOK.COM]=60; // repetir
    this.tab[63][TOK.RB]=9;   // cerrar lista → ir a 9 (como si fuera cadena)
    // resto igual
    this.tab[10][TOK.IMPRIMIR]=11;
    this.tab[11][TOK.CADENA]=12;
    this.tab[12][TOK.PC]=13;
    this.tab[13][TOK.LEER]=14;
    this.tab[14][TOK.VAR]=15;
    this.tab[15][TOK.PC]=16;
    this.tab[16][TOK.PARA]=17;
    this.tab[17][TOK.CADA]=18;
    this.tab[18][TOK.VAR]=19;
    this.tab[19][TOK.EN]=20;
    this.tab[20][TOK.VAR]=21;
    this.tab[21][TOK.HACER]=22;
    this.tab[22][TOK.AL]=23;
    this.tab[23][TOK.DESCARGAR]=24;
    this.tab[24][TOK.AP]=25;
    this.tab[25][TOK.VAR]=26;
    this.tab[26][TOK.PUN]=27;
    this.tab[27][TOK.VAR]=28;
    this.tab[28][TOK.COM]=29;
    this.tab[29][TOK.MP3]=30;
    this.tab[30][TOK.COM]=31;
    this.tab[31][TOK.VAR]=32;
    this.tab[32][TOK.PUN]=33;
    this.tab[33][TOK.VAR]=34;
    this.tab[34][TOK.COM]=35;
    this.tab[35][TOK.CADENA]=36;
    this.tab[36][TOK.CP]=37;
    this.tab[37][TOK.PC]=38;
    this.tab[38][TOK.CL]=39;
    this.tab[39][TOK.FIN]=40;
    this.tab[40][TOK.PC]=41;
    this.tab[41][TOK.CL]=42;
    this.tab[42][TOK.FIN]=43;
    this.tab[43][TOK.ADM]=44;
    this.fin=44;
  }
  nxt(){return this.t[this.p++]??TOK.FIN;}
  run(){
    this.e=0;
    while(true){
      let tk=this.nxt();
      if(tk===TOK.FIN)break;
      let nx=this.tab[this.e][tk];
      if(nx===this.err)return{ok:false,estado:this.e,token:tk,pos:this.p-1};
      this.e=nx;
      if(this.e===this.fin)return{ok:true};
    }
    return{ok:false,estado:this.e};
  }
}

const examples=[
`FUNCION main() {
    VAR link = '';
    IMPRIMIR 'Ingresa la URL del video:';
    LEER link;
    descargar(link, mp4, 'Video1', 'C:/Videos');
} FIN!`,
`FUNCION main() {
    VAR playlist = '';
    IMPRIMIR 'Ingresa la URL de la PLAYLIST:';
    LEER playlist;
    PARA CADA video EN playlist HACER {
        descargar(video.url, mp3, video.nombre, 'C:/Musica/Playlist');
    } FIN;
} FIN!`,
`FUNCION main() {
    VAR enlaces = ['https://youtu.be/v001' AS 'edits', 'https://youtu.be/v002' AS 'Clase1'];
    VAR formato = '';
    IMPRIMIR 'Selecciona el formato: (mp3/mp4/mkv)';
    LEER formato;
    PARA CADA e EN enlaces HACER {
        SI formato ENTONCES {
            descargar(e.url, mp4, e.nombre, 'D:/Videos');
        }
    } FIN;
} FIN!`
];

let tabs=[],cur=0;
function addTab(n,c){tabs.push({n,c});render();}
function render(){
  const el=document.getElementById("tabs");
  el.innerHTML="";
  tabs.forEach((t,i)=>{
    const b=document.createElement("div");
    b.className="tab"+(i===cur?" active":"");
    b.textContent=t.n;
    b.onclick=()=>{cur=i;document.getElementById("code").value=t.c;};
    el.appendChild(b);
  });
}
function loadExample(i){addTab(["Simple","Playlist","Formatos"][i],examples[i]);}

loadExample(0);loadExample(1);loadExample(2);

document.getElementById("code").value=tabs[0].c;

document.getElementById("runBtn").onclick=()=>{
  const src=document.getElementById("code").value;
  const lex=new Lexer(src);const tk=lex.tokenize();
  const cons=document.getElementById("console");cons.innerHTML="";
  for(let i=0;i<tk.length;i++){cons.innerHTML+=tokenName(tk[i])+" ";}
  const p=new Parser(tk);const r=p.run();
  cons.innerHTML+="\n\n"+(r.ok?"✅ Sintaxis correcta":"❌ Error en estado "+r.estado+" token "+tokenName(r.token));
};

function tokenName(t){for(const k in TOK)if(TOK[k]===t)return k;return t;}

document.getElementById("uploadBox").onclick=()=>document.getElementById("fileInput").click();
document.getElementById("fileInput").onchange=e=>{
  const f=e.target.files[0];if(!f)return;
  const r=new FileReader();
  r.onload=x=>{addTab(f.name,x.target.result);document.getElementById("code").value=x.target.result;};
  r.readAsText(f);
};
</script>
</body>
</html>
